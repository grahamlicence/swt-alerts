/*! SWT-Alerts 2014-11-27 10:58 */
var SWT={global:{xmlToJson:function(a){function b(a){var b={title:a.getElementsByTagName("title")[0].innerHTML,description:a.getElementsByTagName("description")[0].innerHTML,pubDate:a.getElementsByTagName("pubDate")[0].innerHTML,category:a.getElementsByTagName("category")[0].innerHTML};a.getElementsByTagName("link").length&&(b.link=a.getElementsByTagName("link")[0].innerHTML),c.items.push(b)}var c={items:[]},d=(a.getElementsByTagName("channel"),a.getElementsByTagName("item"));c.date=a.getElementsByTagName("pubDate")[0].innerHTML;for(var e=0;e<d.length;e+=1)b(d[e]);return c},pubsub:{topics:{},subUid:-1},sub:function(a,b){SWT.global.pubsub.topics[a]||(SWT.global.pubsub.topics[a]=[]);var c=(++SWT.global.pubsub.subUid).toString();return SWT.global.pubsub.topics[a].push({token:c,func:b}),c},pub:function(a,b){return SWT.global.pubsub.topics[a]?(setTimeout(function(){for(var c=SWT.global.pubsub.topics[a],d=c?c.length:0;d--;)c[d].func(a,b)},0),!0):!1},unsub:function(a){for(var b in SWT.global.pubsub.topics)if(SWT.global.pubsub.topics[b])for(var c=0,d=SWT.global.pubsub.topics[b].length;d>c;c++)if(SWT.global.pubsub.topics[b][c].token===a)return SWT.global.pubsub.topics[b].splice(c,1),a;return!1}},settings:{path:"http://rss.journeycheck.com/southwesttrains/southwesttrains/route?action=search&from=",fromSt:"",toSt:"",useTube:!1,tubeStation:""},service:{notification:!1,notificationItems:[],delays:!1,delaysItems:[],cancellations:!1,cancellationsItems:[]},updates:{none:!0,general:!1,generalItems:[],line:!1,lineItems:[],station:!1,stationItems:[]},title:"Good Service",url:"",get:function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a),d.onload=function(){200==d.status?b(d):c(Error(d.statusText))},d.onerror=function(){c(Error("Network Error"))},d.send()})},dataSort:function(a){SWT.data=SWT.global.xmlToJson(a.responseXML),chrome.runtime.sendMessage({msg:"dataupdate"})},dataError:function(a){console.error("Failed!",a)},updateData:function(){SWT.updateSettings(),SWT.get(SWT.url).then(SWT.dataSort,SWT.dataError)},categoriseItem:function(a){function b(){var b=a.title,c=a.description;switch(!0){case b.contains("Delays"):case c.contains("delayed"):SWT.service.delays=!0,SWT.service.delaysItems.push(a);break;case b.contains("Cancellations"):case c.contains("terminated"):case c.contains("cancelled"):SWT.service.cancellations=!0,SWT.service.cancellationsItems.push(a);break;case b.contains("Adverse Weather Timetable"):case c.contains("This train will now run as scheduled"):case c.contains("all lines are now open"):case c.contains("all lines have now reopened"):case c.contains("First class not available"):case c.contains("Toilets are not available"):case c.contains("Catering is not available"):case c.contains("will call additionally"):case c.contains("coaches instead of"):case c.contains("will be started from"):SWT.service.notification=!0,SWT.service.notificationItems.push(a);break;case c.contains("some lines are blocked"):case c.contains("all lines are blocked"):case c.contains("fewer trains are able to run"):case c.contains("trains have to run at reduced speed"):SWT.updates.line=!0,SWT.updates.lineItems.push(a);break;case b.contains("Leaf Fall Timetable Alterations"):case b.contains("Normal Weekday Timetable"):case b.contains("Customer Information Systems"):SWT.updates.general=!0,SWT.updates.generalItems.push(a);break;default:SWT.service.notification=!0,SWT.service.notificationItems.push(a)}}function c(){switch(!0){case a.category.contains("Service Updates"):b();break;case a.category.contains("Station Updates"):SWT.updates.station=!0,SWT.updates.stationItems.push(a);break;case a.category.contains("General Updates"):SWT.updates.general=!0,SWT.updates.generalItems.push(a);break;case a.category.contains("Line Updates"):SWT.updates.line=!0,SWT.updates.lineItems.push(a)}}a.category.length?c():b()},checkStatus:function(){var a=SWT.data.items;SWT.service={notification:!1,notificationItems:[],delays:!1,delaysItems:[],cancellations:!1,cancellationsItems:[]},SWT.updates={none:!0,general:!1,generalItems:[],line:!1,lineItems:[],station:!1,stationItems:[]},console.log(a),a.forEach(SWT.categoriseItem),console.log(SWT),chrome.runtime.sendMessage({msg:"datacat"})},setIcon:function(){SWT.title="Good Service",SWT.icon="service-good",SWT.updates.line?(SWT.title="Line Blocked",SWT.icon="service-cancellations"):SWT.service.cancellations?(SWT.title="Trains Cancelled",SWT.icon="service-cancellations"):SWT.service.delays?(SWT.title="Trains Delayed",SWT.icon="service-delays"):SWT.service.notification?(SWT.title="Service Change",SWT.icon="service-notification"):SWT.updates.general?(SWT.title="Service Announcement",SWT.icon="service-notification-message"):SWT.updates.station&&(SWT.title="Station Update",SWT.icon="service-good-message"),chrome.browserAction&&(chrome.browserAction.setIcon({path:"images/"+SWT.icon+".png"}),chrome.browserAction.setTitle({title:SWT.title}))},updateSettings:function(){this.settings.fromSt=localStorage.from||"",this.settings.toSt=localStorage.to||"",this.settings.useTube="true"===localStorage.useTube?!0:!1,this.settings.tubeStation=""===this.settings.fromSt?"":"THIS_STATION",SWT.setUrl()},setUrl:function(){this.url=SWT.settings.path+SWT.settings.fromSt+"&to="+SWT.settings.toSt+"&period=today&formTubeUpdateLocation="+SWT.settings.tubeStation+"&formTubeUpdatePeriod=&savedRoute="},init:function(){this.updateSettings(),setInterval(function(){SWT.updateData()},3e5),this.updateData(),chrome.runtime.onMessage.addListener(function(a){"stationupdate"===a.msg?SWT.updateData():"dataupdate"===a.msg?SWT.checkStatus():"datacat"===a.msg&&SWT.setIcon()})}};String.prototype.contains=function(a){return-1!=this.indexOf(a)},SWT.init();