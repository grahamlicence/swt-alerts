/*! SWT-Alerts 2014-11-27 10:58 */
Array.prototype.has=function(a){for(i=0,l=this.length;l>i;i+=1)if(this[i].shortname===a)return i;return!1},chrome.runtime.getBackgroundPage(function(a){console.log(a.SWT);var b=a.SWT||{};console.log(b),b.preferences={open:!1,toggle:function(a){a&&a.preventDefault();var c=document.querySelectorAll(".preferences")[0];b.preferences.open?c.className=c.className.replace(" open",""):c.className+=" open",b.preferences.open=!b.preferences.open},displayIssues:function(){function a(a){a.parentNode.className+=" no-issues",a.innerHTML="<p>No known issues.</p>"}function c(a,b){a.parentNode.className=a.parentNode.className.replace(" no-issues",""),b.forEach(function(b){a.innerHTML+="<p><strong>"+b.title+"</strong><span>"+b.description+"</span><p>"})}var d={general:document.querySelector(".general"),line:document.querySelector(".line"),service:document.querySelector(".service"),station:document.querySelector(".station")};d.general.innerHTML="",d.line.innerHTML="",d.service.innerHTML="",d.station.innerHTML="",b.service.cancellations&&c(d.service,b.service.cancellationsItems),b.service.notification&&c(d.service,b.service.notificationItems),b.service.delays&&c(d.service,b.service.delaysItems),b.service.cancellations||b.service.notification||b.service.delays||a(d.service),b.updates.general?c(d.general,b.updates.generalItems):a(d.general),b.updates.line?c(d.line,b.updates.lineItems):a(d.line),b.updates.station?c(d.station,b.updates.stationItems):a(d.station)},setDate:function(){var a=new Date(b.data.date);document.querySelectorAll(".pubdate")[0].innerHTML=a.toLocaleTimeString()},setStations:{populate:function(a,b,c){var d=document.getElementById(b.getAttribute("data-short-input"));b.value=a.innerHTML,d.value=a.getAttribute("data-short"),console.log(a),console.log(d.value),c.innerHTML=""},autoFill:function(a,b){var c=a.value.toUpperCase(),d="";if(!c.length)return void(b.innerHTML="");for(b.style.display="block",(0===c.indexOf("W")||0===c.indexOf("WA")||0===c.indexOf("WAT")||0===c.indexOf("WATE")||0===c.indexOf("WATER")||0===c.indexOf("WATERL")||0===c.indexOf("WATERLO")||0===c.indexOf("WATERLOO"))&&(d+='<a href="" class="stationauto" data-short="WAT">LONDON WATERLOO</a>'),i=0,l=Base.stations.length;l>i;i+=1)0===Base.stations[i].name.indexOf(c)&&(d+='<a href="" class="stationauto" data-short="'+Base.stations[i].shortname+'">'+Base.stations[i].name+"</a>");b.innerHTML=d},autocomplete:function(a,c,d){var e;(a.keyCode>=65&&a.keyCode<=90||8===a.keyCode)&&b.preferences.setStations.autoFill(c,d),e=d.querySelectorAll(".stationauto");for(var f=0,g=e.length;g>f;f+=1)e[f].addEventListener("click",function(a){a.preventDefault();var e=this.innerHTML;console.log(e),b.preferences.setStations.populate(this,c,d)})},chooseFirst:function(a,c,d){var e;e=d.querySelectorAll("a"),console.log(e),e.length&&b.preferences.setStations.populate(e[0],c,d)},save:function(a){a&&a.preventDefault();var b=document.getElementById("fromshort"),c=document.getElementById("toshort"),d=document.querySelector(".from-set"),e=document.querySelector(".to-set"),f=document.getElementById("from").value,g=document.getElementById("to").value;localStorage.from=b.value,localStorage.to=c.value,console.log(c.value),d.innerHTML=f.length?"from "+f:"",e.innerHTML=g.length?"to "+g:"",chrome.runtime.sendMessage({msg:"stationupdate"})},switchDirection:function(a){a.preventDefault();var c=document.getElementById("fromshort"),d=document.getElementById("from"),e=c.value,f=d.value,g=document.getElementById("toshort"),h=document.getElementById("to"),i=g.value,j=h.value;c.value=i,d.value=j,g.value=e,h.value=f,b.preferences.open||b.preferences.setStations.save()},init:function(){function a(a){g[a].addEventListener("keyup",function(c){b.preferences.setStations.autocomplete(c,g[a],i[a])}),g[a].addEventListener("keydown",function(c){console.log(c.keyCode),13===c.keyCode?b.preferences.setStations.chooseFirst(c,g[a],i[a]):27===c.keyCode&&(g[a].value="",h[a].value="",b.preferences.setStations.autoFill(g[a],i[a]))})}function c(a,b,c,d){"WAT"===a?(g[b].value="LONDON WATERLOO",name="LONDON WATERLOO"):(point=Base.stations.has(a),name=Base.stations[point].name,g[b].value=name),console.log(name.lenth),name.length||(d=""),c.innerHTML=d+name}for(var d=document.querySelector(".js-switch"),e=document.querySelector(".js-clear-from"),f=document.querySelector(".js-clear-to"),g=document.querySelectorAll(".js-input"),h=document.querySelectorAll(".js-short-input"),i=document.querySelectorAll(".js-autocomplete"),j=document.querySelectorAll(".js-save")[0],k=document.getElementById("fromshort"),l=document.getElementById("toshort"),m=localStorage.from||"",n=localStorage.to||"",o=document.querySelector(".from-set"),p=document.querySelector(".to-set"),q=0,r=g.length;r>q;q+=1)a(q);k.value=m,l.value=n,m&&c(k.value,0,o,"from "),n&&c(l.value,1,p,"to "),e.addEventListener("click",function(a){a.preventDefault(),g[0].value="",h[0].value="",b.preferences.setStations.autoFill(g[0],i[0])}),f.addEventListener("click",function(a){a.preventDefault(),g[1].value="",h[1].value="",b.preferences.setStations.autoFill(g[1],i[1])}),j.addEventListener("click",function(){b.preferences.setStations.save(),b.preferences.toggle()}),d.addEventListener("click",b.preferences.setStations.switchDirection)}},init:function(){var a=document.querySelector(".js-preferences"),c=document.querySelector(".js-close-preferences"),d=document.querySelector(".js-close-popup");a.addEventListener("click",this.toggle),c.addEventListener("click",this.toggle),d.addEventListener("click",function(){window.close()}),chrome.runtime.onMessage.addListener(function(a){"dataupdate"===a.msg?b.preferences.setDate():"datacat"===a.msg&&b.preferences.displayIssues()}),b.preferences.setStations.init(),b.preferences.setDate(),b.preferences.displayIssues()}},b.hideNotification={},b.preferences.init()});